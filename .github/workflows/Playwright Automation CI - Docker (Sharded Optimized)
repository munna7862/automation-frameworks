name: Playwright Automation CI - Docker (Sharded Optimized)

on:
  workflow_dispatch:
    inputs:
      shards:
        description: "Number of shards to run in parallel"
        required: false
        default: "4"
      env:
        description: "Target environment name"
        required: false
        default: "qa"
      base_url:
        description: "Base URL for UI tests"
        required: false
        default: "https://automationexercise.com/"
      api_base_url:
        description: "Base URL for API tests"
        required: false
        default: "https://reqres.in"
      headless:
        description: "Run browser in headless mode (true/false)"
        required: false
        default: "true"
      browser:
        description: "Browser name (chromium, firefox, webkit)"
        required: false
        default: "chromium"

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  set-matrix:
    name: Set shard matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Build shard matrix
        id: set-matrix
        env:
          SHARDS: ${{ github.event.inputs.shards }}
        run: |
          python - <<'PY'
          import json
          import os

          shards = int(os.environ.get('SHARDS', '4'))
          matrix = {
              'shardIndex': list(range(1, shards + 1)),
              'shardTotal': [shards]
          }

          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"matrix={json.dumps(matrix)}\n")
          PY

  test-sharded:
    name: UI & API Automation (Docker Shard ${{ matrix.shardIndex }}/${{ matrix.shardTotal }})
    runs-on: ubuntu-latest
    needs: [set-matrix]
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.set-matrix.outputs.matrix) }}

    container:
      image: mcr.microsoft.com/playwright:v1.58.0-jammy

    env:
      ENV: ${{ github.event.inputs.env }}
      BASE_URL: ${{ github.event.inputs.base_url }}
      API_BASE_URL: ${{ github.event.inputs.api_base_url }}
      HEADLESS: ${{ github.event.inputs.headless }}
      BROWSER: ${{ github.event.inputs.browser }}

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        working-directory: playwright-e2e
        run: |
          npm ci

      - name: Run shard
        working-directory: playwright-e2e
        env:
          ENVIRONMENT: INTEROP
          TZ: Australia/Adelaide
        run: |
          npx playwright test --config=src/config/playwright.config.ts --shard=${{ matrix.shardIndex }}/${{ matrix.shardTotal }}

      - name: Upload shard Allure Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-shard-${{ matrix.shardIndex }}
          path: playwright-e2e/reports/allure-results

  deploy-report:
    name: Deploy Consolidated Allure Report
    needs: [test-sharded]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages

      - name: Download all shard Allure Results
        uses: actions/download-artifact@v4
        with:
          pattern: allure-results-shard-*
          path: allure-results
          merge-multiple: true

      - name: Generate Allure Report
        uses: simple-elf/allure-report-action@master
        with:
          allure_results: allure-results
          gh_pages: gh-pages
          allure_report: allure-report
          allure_history: allure-history
          keep_reports: 7
          subfolder: AutomationReports/UI

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: allure-history
          keep_files: true

      - name: Print Report URL
        run: |
          REPO_NAME="${{ github.event.repository.name }}"
          OWNER="${{ github.repository_owner }}"
          echo "âœ… Report published successfully!"
          echo "ðŸ“Š Report URL: https://${OWNER}.github.io/${REPO_NAME}/AutomationReports/UI/${{ github.run_number }}"
